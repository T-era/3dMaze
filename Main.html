<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="Mz.css"></link>
		<link rel="stylesheet" type="text/css" href="MzE.css"></link>
		<link rel="stylesheet" type="text/css" href="jquery-ui.min.css"></link>
		<link rel="stylesheet" type="text/css" href="my_dialog_style.css"></link>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
		<script type="text/javascript" src="jquery-ui.min.js"></script>
		<script type="text/javascript" src="MyDialog.js"></script>
		<script type="text/javascript" src="ComplexSelect.js"></script>
		<script type="text/javascript" src="Mz_main.js"></script>
		<script type="text/javascript" src="Mz_rooms.js"></script>
		<script type="text/javascript" src="Mz_field.js"></script>
		<script type="text/javascript" src="Mz_draw.js"></script>

		<script type="text/javascript" src="MzE_Main.js"></script>
		<script type="text/javascript" src="MzE_baseSetting.js"></script>
		<script type="text/javascript" src="MzE_Floor.js"></script>
		<script type="text/javascript" src="MzE_EditMode.js" ></script>
		<script type="text/javascript" src="MzE_SourceIO.js" ></script>
		<script type="text/javascript" src="ColorPicker.js" ></script>
		<script type="text/javascript" >
$(function() {
	var cs = new ComplexSelect($("#saved_maps"), loadMap);
	cs.setLoader(loadAllMap(toSelectItem));
	cs.reload();

	function loadAllMap(fConvert) {
		return function() {
			var list = [];
			for (var i = 0, max = localStorage.length; i < max; i ++) {
				var key = localStorage.key(i);
				list.push(fConvert(key));
			}
			return list;
		}
	}
	function toSelectItem(item) {
		return {
			doms: [
				$("<span>").text(item),
				$("<div>")
					.text("削除")
					.addClass("like_button")
					.addClass("right")
					.css({
						height: "16px",
						background: "#fdd" })
					.click(function() {
						localStorage.removeItem(item);
						cs.reload();
						return false;
					}),
				$("<div>")
					.text("編集")
					.addClass("like_button")
					.addClass("right")
					.css({
						height: "16px" })
					.click(function() {
						// TODO 消してどうする
						localStorage.removeItem(item);
						cs.reload();
						return false;
					})
			],
			value: item
		};
	}
	function loadMap(key) {
		MyDialog.UserConfirm("迷路の初期化", "迷路 " + key + " をロードします。",
			function(callback) {
				eval(localStorage.getItem(key));
				Mz.onLoad();
				callback();
			},
			function(callback) {
				callback();
			});
	}
	$("#main_new_button").click(function() {
		Mz.enable(false);
		MzE.openBaseSetting("新しい迷路を作成",
			function(setting, callback) {
				if (createNewMap(setting)) {
					callback();
				}
			},
			function() {
				Mz.enable(true);
			});
	});

	function createNewMap(setting) {
		if (setting.xSize < 1) { alert("迷路の広さ x を指定して！"); return false; }
		if (setting.ySize < 1) { alert("迷路の広さ y を指定して！"); return false; }
		if (setting.zSize < 1) { alert("迷路の広さ z を指定して！"); return false; }
		if (! setting.name) { alert("迷路に名前をつけて！"); return false; }
		if (setting.name in localStorage) { alert("その名前の迷路は作れない！\n(おなじ名前の迷路が既に登録されていかも)"); return false; }

		MzE.toEdit(setting);

		cs.reload();
		return true;
	}
});
		</script>
	</head>
	<body onload="Mz.onLoad();">
		<canvas id="main" class="main_canvas"></canvas>
		<div class="main_control">
			<div id="main_new_button" class="main_new_button"></div>
			<div id="saved_maps" class="main_selector"></div>
		</div>
		<div id="baseSettngs">
			<ul class="no_mark">
				<li><label for="nameIn">Name</label><input type="text" id="nameIn" ></input></li>
				<li><label for="xSizeIn">X</label><input type="number" id="xSizeIn" ></input></li>
				<li><label for="ySizeIn">Y</label><input type="number" id="ySizeIn" /></li>
				<li><label for="zSizeIn">Z</label><input type="number" id="zSizeIn" /></li>
			</ul>
		</div>
		<div id="edit">
			<select id="floorSelect" onchange="MzE.editMode.selectFloor()"></select>
			<div id="colorPointer">
				R:<input type="number" id="rIn" onchange="MzE.editMode.inputColor()" />
				G:<input type="number" id="gIn" onchange="MzE.editMode.inputColor()" />
				B:<input type="number" id="bIn" onchange="MzE.editMode.inputColor()" />
			</div>
			<div id="output" class="MzEditor" ></div>
			<button type="button" id="EzE_Save">Save</button>
			<button type="button" onclick="MzE.editMode.exp()">Export</button>
			<button type="button" onclick="MzE.editMode.inp()">Inport</button>
			<textarea id="src"></textarea>
		</div>
	</body>
</html>
